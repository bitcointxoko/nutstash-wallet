import { browser } from '$app/environment';
import { PUBLIC_SELFHOSTED } from '$env/static/public';
import type { Mint } from '../../src/model/mint';

import { get, writable } from 'svelte/store';
import { isSyncMints, selfhostedSyncTokens } from './selfhosted';

const initialMint: Array<Mint> = [
	{
		mintURL: 'https://bitcointxoko.com/cashu/api/v1/dMk78c5aR7uhHzcqH3Bwqp',
		keys: { "1": "03ff741c0ce0703733997a0adf355867b965e8cf893c93a7f1662bc2d62c1f543a", "2": "0334c79133ad07171440edad04426b0b9b2d8d7fb4157807cca07143eace8a5816", "4": "03622b3309403433cc28791616fe802a0233660b95a61a467fde61765b95834a04", "8": "03d7a771b61315b20b54d1fdd87ce31bf4eb1bdcf31f13f3e097b462907afbd4b1", "16": "02d7f8bcbb1a78aaa028012c9e2de79b165877e01a1d9542966133b36a406072bc", "32": "0280fd51b5b7690744277379591b74d0aca3680e13161e1ca08bcb0f95a2c2b9f2", "64": "025f2188fd6790d7ccfb4a700537b29c37b4e27f52d97c97437cc984c2347756c2", "128": "03601f9af86b71ad7d46c22097a3949a1d955840bdc94e5033ca5392e1845c6b0a", "256": "02802c6f5db9374715ef711c2b01360beb1ff67ed48f0473de16c56d92f3c99321", "512": "029a1e19508fbc520bc72d7d9be712b2fe28c0eb32b4c7b294c9e936f226f91327", "1024": "03e368e23ce59979ea05613f7fb63854e4906117952cfe659f708ad9fb6c90fb9a", "2048": "03f20c92bc20afe19554baf4d8c4e885d16b540b3a2598d739a621b76fae753199", "4096": "034054cc6ed47973df73217b7ef022585e9b579afd01911ad2a5972431fa7ba7f0", "8192": "03906b12b4409ff5cb4531c851150963b71013cb29fe221d5856c6568a98d72418", "16384": "0388f5387c2a769c5feaddb80b728d3c4bb2d7ddb9a474e90c6e804e81afdbae91", "32768": "02a8a2ab199ebaa320a43839325f3542c834d3172f168f4fd65a0543ec6b44c594", "65536": "03037b9d73873eb69a306738fcd37b7bff94bcac0edf98bef0ccd1043617f0d625", "131072": "02789aa0578a7b379c456049e22aa13c08c1d93e8536afac766827f65c9de1d921", "262144": "02e029ca07fabcf9b8fd547133b81759f48d574954fc0168201d0a96695b3bc780", "524288": "021f6839d4d4336366bbd2a6ee50de60eb4cbe10ea3b68a0167a83c2419f518d62", "1048576": "02e766bfad3e0dc480fbe302aedaa9265ddfc07cf4c1f56ef40072b166580f9ae5", "2097152": "024accb7723a1fbd9553b87228a40e2ef1f8c5be160935b93869daa273f5e51b5d", "4194304": "020c6e5a46e7d4818361c7dda12983e47b85e307ee37079eadbae0cee1736194d2", "8388608": "020b3fc9e03c00d31312a0c8fee5eab98f25dd4d86b66791161192bf8778b2c9cc", "16777216": "031a72d51febb17d192243eec07814d6f964c2e022d101c316bfcf77aa71cafdf9", "33554432": "03f6f6660918319852aa7b8caf3cbc81f88cdbe00d980ddae13c2371b5e27e47b2", "67108864": "02af88686ddd58143b6bd253f2392f1ad6562675f43e23f938da659acac4c7be8b", "134217728": "038865ea99204463ce84bea8a5519a7fe22ebcb19ec5773334fc991a0f529119fd", "268435456": "03de137fec7f0e9eead710e1fc7e232a04c64eef7cd894d6e4a90321a654dfffbc", "536870912": "03eb0e4e3f12ceb9305fc6353306035cbcc295a3b6c227c66f38bc6617a169064b", "1073741824": "033f93bf823bd4f14f0b474ae8cfd16c16e11ee0278564f6ceff2192bbdf9b3118", "2147483648": "02e13ee31e7c16446743ee8a2f8f234254f27cd9f025f038dc28d093ff969dbcb4", "4294967296": "021a9be5295caaabe649efc8cd81660e5b6e7c1826a7c499ade62633c9a406f1f1", "8589934592": "0206f04b42bf96c85650b057a7465e71c6fadfc362a2a3f68f154e3b9d06953478", "17179869184": "03e75f569896013de302580c8dd8f67aec76ab7694c2f39f7c7cff92f1f24395f9", "34359738368": "02fcfdb33fb4d554c9e95b0b91edc4e7eb592648be0f6c0e4fd031f49088caaec2", "68719476736": "022fdb4e97b8535aeb7a51fdb30cc202d54c58349b4e132b0b3b47735de60b83ca", "137438953472": "037a350c5d4ccee484144cc7b8915810b8466c8365fa2fb3be714685a00dc02514", "274877906944": "02427aca808a0283075df8dffc7e4e24ab59179dfd175660aeda93b8de7d78641d", "549755813888": "032455dfc5bd5808e09cd5bc60f79bdddfcd20bcea2fc877d6d17ff7d0546add3f", "1099511627776": "029998348e5f9e3f91be8468e710c06bd20d288b4dbdc5c07965a1b755c57607bf", "2199023255552": "02dc2f3300446daa031f5af0dda41af941ca931a9bcebb16e39d3234f56a07375b", "4398046511104": "0265c1bf7eec747a95b3e4a1db5caf156152f78a7a680e9dd50044c95b38698e79", "8796093022208": "021fefe13f6d8826a84b510137f4c6e7e5544b80afab34f45449bcb14a769134ad", "17592186044416": "02c7afb3e206ee764e7f916a5c223c4c01bc260017ff30bd14d977b216cd4be0f7", "35184372088832": "0360c1fc4af45137bcc1633d80ec869f80ef344f3b9fd49b6bdee1e0682e36bd3c", "70368744177664": "0224291e6fd942503962e3f11e97485938220591620aba32b02aa430faf001eb5c", "140737488355328": "0229dcd158f94740b7aea05fa73a79054ffe411e5fda4aba54facf0044db484944", "281474976710656": "02d61507dcd3c797f545f361902637fb7457f891a793f06afd0d50b1e521d75ac0", "562949953421312": "03c981eb6aae1860c9a9c56909827c3f4117f29f8bb200d2c22bd4a908ecc20e83", "1125899906842624": "03b697d335e7efbc3081d559d78543a5e86f5310769f52b8fd33fd468d65f3e709", "2251799813685248": "0297029c885ee0a9e5fd1eff4819b6964b55f420b61199aa67eec12d6e24b8583d", "4503599627370496": "0247dd918d53b0f55ea678cf9b2bc325f63369d9b6a4bc47fa36f14de6b566bb71", "9007199254740992": "02c5551f193d38aa67671210a1151867e195bf3cecfe845896f1eb890ba8929e3d", "18014398509481984": "03bc05cfde39b4f36215817182be889e5ae51848fcdfa3770bb4f6262d952c119d", "36028797018963968": "0299396fcc33c5f133f7a252c6434f879f610c77b4c2afad88d8ac5d132896434d", "72057594037927936": "03e3fa59e7072330ac34b40e0e6490a312dfea8176744e4f2a13ca66d35e1e2bdd", "144115188075855872": "03dcf10705886cd4077f458c76f2860b21ac51f7731ee427266f787b363edcd0d3", "288230376151711744": "036abab6d230b1c1357435958bd08da1bc66a3d4d9fa89e1a28b2d65f3adcb9893", "576460752303423488": "023a6a2f201181d967ed2859c84cab61c2bb782e92b5397af9cc96e2ae7bf11638", "1152921504606846976": "02297e716d72b015335c5612e57620d27606b6978381c00bec594ec0cec56f035d", "2305843009213693952": "03b5f9c26a7e0cb2ec982c1cf004f93c294075aa3aad98fd04231a640c7dbd6a15", "4611686018427387904": "038b189c00ad79beff59abe5584ac0f2311743095e49eb7c79693fbc8d4bdcbf87", "9223372036854775808": "035208962566dd5617343feb3267e4ebb2f5d32856c8e9419c721e8b2d7e5ec967" },
		keysets: ["ux0bR5EZG3y/"],
		isAdded: false
	}
];

const initialValueSting: string = browser
	? window.localStorage.getItem('mints') ?? JSON.stringify(initialMint)
	: JSON.stringify(initialMint);

const initialValue: Array<Mint> = JSON.parse(initialValueSting);

const mints = writable<Array<Mint>>(initialValue);

mints.subscribe(async (value) => {
	if (browser) {
		const stringValue = JSON.stringify(value);
		window.localStorage.setItem('mints', stringValue);
		if (PUBLIC_SELFHOSTED && get(selfhostedSyncTokens)) {
			isSyncMints.set(true);
			await fetch('/api/backup/mints', {
				method: 'post',
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json'
				},
				body: stringValue
			});
			isSyncMints.set(false);
		}
	}
});

export { mints };
